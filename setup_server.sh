#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¿ÐµÑ€Ð²Ð¾Ð¹ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð±Ð¾Ñ‚Ð° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
# Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (Ð½Ðµ root)

set -e  # ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ

echo "ðŸš€ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Telegram Shorts Bot"
echo "=================================="

# 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Python
echo ""
echo "1ï¸âƒ£ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Python..."
if ! command -v python3 &> /dev/null; then
    echo "âŒ Python3 Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸ ÐµÐ³Ð¾:"
    echo "   sudo apt update && sudo apt install python3 python3-pip python3-venv -y"
    exit 1
fi
echo "âœ… Python Ð½Ð°Ð¹Ð´ÐµÐ½: $(python3 --version)"

# 2. Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð±Ð¾Ñ‚Ð°
echo ""
echo "2ï¸âƒ£ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸..."
BOT_DIR="$HOME/tg_shorts_bot"
if [ -d "$BOT_DIR" ]; then
    echo "âš ï¸  ÐŸÐ°Ð¿ÐºÐ° $BOT_DIR ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
    read -p "Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¸ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð·Ð°Ð½Ð¾Ð²Ð¾? (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf "$BOT_DIR"
        echo "âœ… Ð¡Ñ‚Ð°Ñ€Ð°Ñ Ð¿Ð°Ð¿ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð°"
    fi
fi

if [ ! -d "$BOT_DIR" ]; then
    mkdir -p "$BOT_DIR"
    echo "âœ… ÐŸÐ°Ð¿ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð°: $BOT_DIR"
fi

cd "$BOT_DIR"

# 3. ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
echo ""
echo "3ï¸âƒ£ ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
read -p "Ð’Ð²ÐµÐ´Ð¸ URL Ñ‚Ð²Ð¾ÐµÐ³Ð¾ GitHub Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: https://github.com/username/repo.git): " REPO_URL

if [ -z "$(ls -A $BOT_DIR)" ]; then
    git clone "$REPO_URL" .
    echo "âœ… Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ ÑÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½"
else
    echo "âš ï¸  ÐŸÐ°Ð¿ÐºÐ° Ð½Ðµ Ð¿ÑƒÑÑ‚Ð°Ñ, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÑŽ ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ"
fi

# 4. Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
echo ""
echo "4ï¸âƒ£ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
if [ ! -d "venv" ]; then
    python3 -m venv venv
    echo "âœ… Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¾"
else
    echo "âš ï¸  Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
fi

# 5. ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ venv Ð¸ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo ""
echo "5ï¸âƒ£ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
echo "âœ… Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"

# 6. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° .env Ñ„Ð°Ð¹Ð»Ð°
echo ""
echo "6ï¸âƒ£ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° .env Ñ„Ð°Ð¹Ð»Ð°..."
if [ ! -f ".env" ]; then
    cp .env.example .env
    echo "âœ… Ð¤Ð°Ð¹Ð» .env ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸Ð· .env.example"
    echo ""
    echo "âš ï¸  Ð’ÐÐ–ÐÐž: ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹ Ñ„Ð°Ð¹Ð» .env Ð¸ Ð´Ð¾Ð±Ð°Ð²ÑŒ ÑÐ²Ð¾Ð¸ Ñ‚Ð¾ÐºÐµÐ½Ñ‹:"
    echo "   nano .env"
    echo ""
    read -p "ÐÐ°Ð¶Ð¼Ð¸ Enter ÐºÐ¾Ð³Ð´Ð° Ð¾Ñ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐµÑˆÑŒ .env..."
else
    echo "âš ï¸  Ð¤Ð°Ð¹Ð» .env ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
fi

# 7. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° systemd ÑÐµÑ€Ð²Ð¸ÑÐ°
echo ""
echo "7ï¸âƒ£ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° systemd ÑÐµÑ€Ð²Ð¸ÑÐ°..."

# Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ service Ñ„Ð°Ð¹Ð» Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð¿ÑƒÑ‚ÑÐ¼Ð¸
SERVICE_FILE="/tmp/tg-shorts-bot.service"
cat > "$SERVICE_FILE" << EOF
[Unit]
Description=Telegram Shorts Bot
After=network.target

[Service]
Type=simple
User=$USER
WorkingDirectory=$BOT_DIR
Environment="PATH=$BOT_DIR/venv/bin"
ExecStart=$BOT_DIR/venv/bin/python main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

echo "ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÑŽ service Ñ„Ð°Ð¹Ð» Ð² /etc/systemd/system/..."
sudo cp "$SERVICE_FILE" /etc/systemd/system/tg-shorts-bot.service
sudo systemctl daemon-reload
echo "âœ… Systemd ÑÐµÑ€Ð²Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"

# 8. Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°
echo ""
echo "8ï¸âƒ£ Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°..."
sudo systemctl enable tg-shorts-bot
sudo systemctl start tg-shorts-bot
echo "âœ… Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"

# 9. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
echo ""
echo "9ï¸âƒ£ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°..."
sudo systemctl status tg-shorts-bot --no-pager

echo ""
echo "=================================="
echo "âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo ""
echo "ðŸ“ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "   sudo systemctl status tg-shorts-bot   # Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð±Ð¾Ñ‚Ð°"
echo "   sudo systemctl restart tg-shorts-bot  # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº"
echo "   sudo systemctl stop tg-shorts-bot     # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°"
echo "   sudo journalctl -u tg-shorts-bot -f   # Ð›Ð¾Ð³Ð¸ Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸"
echo ""
echo "ðŸ”„ ÐÐ²Ñ‚Ð¾Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· GitHub Actions Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¾!"
echo "   ÐŸÑ€Ð¸ Ð¿ÑƒÑˆÐµ Ð² main Ð²ÐµÑ‚ÐºÑƒ Ð±Ð¾Ñ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑÑ"
